name: Compilar Cronograma Dinâmico

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 9 * * *' # Roda todo dia às 06h (Brasília)
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Processar Cronograma e Compilar
        run: |
          mkdir -p publish
          HOJE=$(date +%Y%m%d)
          
          # Pula o cabeçalho e lê o CSV (ajuste o separador se necessário)
          tail -n +2 dados/cronograma | while IFS=',' read -r numero assunto curta data_csv; do
            
            # Converte data DD/MM/AAAA para AAAAMMDD para comparar
            DATA_ISO=$(echo $data_csv | awk -F'/' '{print $3$2$1}')
            
            if [ "$DATA_ISO" -le "$HOJE" ]; then
              echo "Processando item $numero: $curta"
              
              # Opcional: Passar dados para o LaTeX via comando
              # Isso permite usar \VARNumero no main.tex
              EXTRA_ARGS="\def\VARNumero{$numero}\def\VARAssunto{$assunto}\input{main.tex}"
              
              # Compilação personalizada para cada linha
              pdflatex -jobname="resultado_${numero}" "$EXTRA_ARGS"
              
              # Move para pasta de publicação com nome único
              cp "resultado_${numero}.pdf" "publish/edital_${numero}_${curta}.pdf"
            fi
          done

      - name: Deploy para GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./publish
          keep_files: true
